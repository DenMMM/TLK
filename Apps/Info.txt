                                  TLK 3.11 demo 3
================================================================================
	Компьютерные клубы, наверное уже не существуют... Даже в "глубинке". И все же захотелось вспомнить былое, почувствовать себя крутым программером. :) Последняя разработка "TLK 3.10 demo 6" писалась много лет назад, когда я уже не работал клубе (поэтому все 3.10+ "демо").

	TLK - набор простых программок: клиент, блокирующий запущенные программы на компьютерах, модуль управления клиентами (время работы, настройки), средство просмотра логов, видео-плейер и "костыль" для управления доступом в Интернет.
	TLK - НЕ комплексное решение по защите сдаваемых в аренду ПК. Давайте права ограниченных пользоваталей, используйте обязательные профили и "software restriction policy", заменяйте стандартный shell на клиент TLK. Не забывайте, что он до сих пор пишет в "HKLM\Software\MMM Groups\TLK\3.0\Client" и в файл "C:\Windows\TLK.GMS"... Запрещайте запуск редактора реестра, диспетчера задач и выполнение любых действий при нажатии CTRL+ALT+DEL. Повторять работу твикеров смысла не вижу.

	Модули устроены так, что могут работать максимально автономно. Например, "клиент" сам считает время своей работы/штрафа и постоянная связь с сервером ему в общем-то не нужна: получил новое "состояние" - работай. В 3.10 управление клиентами переведено на UDP, что позволило надежно обслуживать много компьютеров (все же я рекомендую 30-50). Сервер синхронизируется с клиентами каждые три секунды в фоне и сразу после применения команды. Пакеты менее 100байт.
	Реализовано включение компьютеров через WOL с помощью magic-пакетов. Сервер пополняет свой кэш MAC-адресов в процессе работы и сохраняет его между запусками.
	Настройки и список игр "клиентам" можно рассылать/скачивать, сохранять в файл из модуля управления.
	Все настройки и логи хранятся в двоичных файлах собственного формата - никаких баз данных. Сейчас это скорее минус, но не на время разработки... Тем не менее, работа с критичными файлами происходит без кэширования записи с "безопасной" их перезаписью. Похожий механизм в старых версиях даже на IDE HDD + NTFS не вызывал проблем при сбоях питания. Логи очень компактные - десятки килобайт в сутки. Все шифруется своим простеньким потоковым алгоритмом.
	Логи в 3.10 стали заметно сложнее: в них сохраняется вся необходимая информация, чтобы утилита просмотра смогла восстановить состояние зала на любой момент времени. Смена файла происходит при завершении смены. Минимальный период ведения лога задается в настройках.
	Для управления доступом в Интернет есть "костыль" - служба, устанавливаемая на клиенте. Она работает параллельно с оболочкой и считывает ее настройки из реестра при каждом их обновлении. Добавляет/удаляет маршрут по-умолчанию с тем же адресом, что и первичный DNS-сервер в настройках ОС. Время работы считает самостоятельно, поэтому маршрут удаляет надежно. Делать что-то сложнее во времена безлимитного Интернета смысла не вижу. Карточки на dialup и WiFi ушли в прошлое. :)

	"demo 3". Исправил в просмотрщике логов обработку команды "Открыть [для настройки]", добавил фильтры (в контекстном меню на записях лога). В модуле управления добавил быстрый вызов основных операций.
	"demo 2" - не существенные доработки модуля управления и клиента, устранение ошибок. Баг с прозрачностью в режиме shell'а не победил...
	В "demo 1" заменил блокировку программ путем принудительного сворачивания окон на более адекватную... Добавил экспериментальный режим прозрачности shell'а, оптимизацию отрисовки некоторых окон и настройку таймера сообщения об окончании времени. В списке программ теперь не обязательно указывать файл с иконкой. Вернул принудительный режим для перезагрузки и выключения клиента. Исправил не значительные ошибки.
	TLK 3.11 - начал доработку клиента, т.к. он не отвечает даже минимальным современным требованиям.

	В "demo 8" продолжил приводить в порядок код программы, исправлять ошибки и не доработки. Удалил лишние опции и код, добавил описаний. Заменил хранение паролей в "plain text" на хэши. Добавил аутентификацию клиентов и модуля управления через HMAC-SHA, простую защиту от replay-атак. Работает как при синхронизации режима работы, так и при обмене настройками. 
	В "demo 7" в основном выполнил реструктуризацию, чтобы вынести общие части в "ядро" и убрать повторяющийся в разных модулях код. Добавил описаний и обновил до C++Builder 6. Переделал модуль маршрутизации, исправил синхронизацию по UDP (клиент рассылал броадкасты). Чуть улучшил шифрование, но оно осталось "самопальным" с ключем 32-бита.
	В "demo 6" были удалены не реализованные опции, засорявшие интерфейс. Переделан редактор тарифов, диалоги запуска/штрафования стали проще и понятнее. Аккаунт сис.админа заменен единственным паролем для входа в настройки модуля управления. Сам модуль теперь запускается и в отсутствие начатой смены. Добавлены его настройки.
	TLK 3.10 - переработка базового кода.


	По вопросам по функциональности и исходному коду, можно писать на denm.mmm@gmail.com, Денис Матвеев. Если кому-то понравится мой вариант, продолжу работать периодически публикуя исходный код.
	Желающим поддержать сюда: https://money.yandex.ru/to/410015053560405


                               Системные требования
================================================================================
	Любой PentiumPro-совместимый ПК (i586) с 2-4Мбайт свободной RAM для TLK. Для просмотрщика логов может потребоваться больше памяти. Зависит количества записей в логе.
	ОС - Windows от WinXP до Win7 как минимум.


                                 Процесс установки
================================================================================
	Файлы, необходимые для работы клиентской части программы, находятся в директории ClientModule. Картинки с сообщениями необходимо скопировать в директорию Windows, файл шрифта установить вручную.
	Список игр/настройки рассылаются по сети из модуля управления и вручную не редактируются.
	TLK.exe можно, в принципе, "положить" куда угодно, но лучше в директорию Windows.
	Для WinXP разумно устанавливать клиента под конкретного пользователя, прописывая вручную "HKCR\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" ключ "shell"="C:\Windows\TLk.exe".
	Свои настройки клиент хранит в реестре. Исторически в HKLM...
	При старте он обеспечивает запуск приложений перечисленных в "HKLM\Software\Microsoft\Windows\CurrentVersion\Run".
	Админская часть ничего не хранит в реестре. Все что нужно - DAT-файлы.
	Модуль машрутизации регистрируется при выполнении "TLKRte.exe /install". Удаляется, соответственно, "TLKRte.exe /uninstall".


            Замена не нужных программ в системе программой-заглушкой
================================================================================
	При работе с некоторыми играми обнаружилось, что они очень любят открывать приложения типа Internet Eplorer, блокнота или еще чего. А если файлы этих приложений удалены, то открывается обзор по диску, что потенциально дает возможность для взлома компьютера. Чтобы такого не происходило, с TLK 3.0 поставляется маленькая программка ExeRepl.exe . При запуске она просто ничего не делает.


                              Просмотр фильмов
================================================================================
	С TLK 3.0 бета 4.5 поставляется простой видео-плейер.
	Он позволяет воспроизводить медиа-данные типа "MPEGVideo" (расширения файлов для этого типа можно найти в Win.ini, раздел "mci extensions"). Для просмотра фильма нужно занести в список игр примерно следующее:
"C:\WINDOWS\VPlay.exe" D:\Video\Блейд 2.avi
C:\WINDOWS\VPlay.exe
	Поскольку плейер использует MCI, для просмотра фильмов и прослушивания музыки необходимо устанавливать соответствующие кодеки (DivX, например).
	Чтобы не нагружать закрытый компьютер бесполезной работой, плейер автоматически останавливает воспроизведение, если его окно некоторое время не активно.


                  Задание времени при запуске компьютеров
================================================================================
	Время, на которое запускается компьютер, в зависимости от тарифной сетки выбирается из списка или задается с точностью до минуты в виде "часы:минуты". И не забывайте для полутора часов писать последний ноль, т.е. "1:30", а не "1:3".


                 Безопасноть и обращение с файлами настроек, логами
================================================================================
	Т.к. модуль управления выполнен в виде приложения, а не службы, я рекомендую устанавливать его как shell на рабочем месте администратора зала. В прежних версиях была простая защита от подмены лога (как минимум). С 3.10 отказался от всяких ухищрений, т.к. актуальнее использовать средства ОС для разграничения прав доступа: хотя бы запускать по ярлыку от имени пользователя, которому разрешен доступ к файлам модуля управления, или переписать TLK как службу Windows.
	Модуль управления при каждом запуске считывает весь текущий лог для проверки его целостности, определения чья смена начата (да, это берется из лога...) и других служебных параметров. Если лог окажется поврежден, TLK попытается его переименовать и начать новый файл. В любом случае лог не будет удален/перезаписан. Для обеспечения надежной интерпретации просмотрщиком при старте записываются: текущее состояние зала, тарифы, штрафы, пользователи. Далее при выполнении каждой команды в логе сохраняются лишь ID нужного параметра настроек. Поэтому, если оказался поврежден файл USERS.DAT/TARIFFS.DAT/FINES.DAT, рекомендую перед восстановлением из копии начать новый лог. Внутренние ID зависят от системных часов и их уникальность достаточна, но это все же не SQL...
	В случае отсутствия доступа к файлу лога или нехватки места на диске, TLK откажется выполнять команды. Если будет поврежден или не удачно сохранен какой-либо файл настроек, произойдет блокировка модуля управления. Открыть его можно будет только под паролем настроек для устранения проблемы. Если потеряется OPTIONS.DAT, придется генерировать новый используя исходный код TLK...
	Два постоянно изменяющихся файла CURRENT.TLG и STATES.DAT сохраняются на диск без кэширования записи. Необходимое место в них выделяется перед [пере]записью данных, что гарантирует целостность. Файлы открываются только по-необходимости, поэтому даже жесткий reset не должен вызывать проблем.

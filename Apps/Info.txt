                                  TLK 3.11 demo 7
================================================================================
	Компьютерные клубы, наверное уже не существуют... И все же захотелось вспомнить былое, почувствовать себя крутым программером. :)
	TLK писался много лет назад для одного средненького питерского клуба. Еще под Win98... Ради интереса решил актуализировать проект и вспомнить C++.

	TLK - набор простых инструментов: клиент, блокирующий запущенные программы на компьютерах, модуль управления клиентами (время работы и настройки), средство просмотра логов, видео-плейер, программа-заглушка.
	TLK - НЕ комплексное решение по защите сдаваемых в аренду ПК. Давайте права ограниченных пользоваталей, используйте обязательные профили и "software restriction policy", заменяйте стандартный shell безопасным или заглушкой. Запрещайте запуск редактора реестра, диспетчера задач и выполнение любых действий при нажатии CTRL+ALT+DEL. Повторять работу твикеров смысла не вижу.

	Модули устроены так, что могут работать максимально автономно. Например, "клиент" сам считает время своей работы/штрафа и постоянная связь с сервером ему в общем-то не нужна: получил новое "состояние" - работай. Сервер синхронизируется с клиентами каждые три секунды в фоне и сразу после применения команды. Протокол свой, поверх UDP. С аутентификацией через HMAC и защитой от replay-атак. Пакеты крошечные - менее 100байт.
	Реализовано включение компьютеров через WOL с помощью magic-пакетов. Сервер пополняет свой кэш MAC-адресов в процессе работы и сохраняет его между запусками.
	Настройки и список игр "клиентам" можно рассылать/скачивать, сохранять в файл из модуля управления.
	Все настройки и логи хранятся в двоичных файлах собственного формата - никаких баз данных. Тем не менее, приняты меры для безопасной работы с критичными файлами. Логи очень компактные - десятки килобайт в сутки. Все шифруется своим простеньким потоковым алгоритмом.
	В логах сохраняется вся необходимая информация, чтобы утилита просмотра смогла восстановить состояние зала на любой момент времени. Смена файла происходит при завершении смены. Минимальный период ведения лога настраивается.
	Тарифы минимально необходимые: почасовые, пакеты на несколько часов, ночные. С привязкой к компьютерам, разрешенным группам программ и дополнительным опциям.
	Управление доступом в Интернет реализовано без прокси - изменением маршрута по-умолчанию на клиенте... Гибкости никакой, зато можно поставить несколько компьютеров и Zyxel/Mikrotik - все что нужно для работы.
	Клиент - служба, блокирующая рабочий стол заданного в настройках пользователя. Свою оболочку запускает при входе пользователя в систему и перезапускает ее в случае "падения". При блокировке компьютера не "убивает" запущенные программы (если отключить авто-перезагрузку). Синхронизирует системные часы с модулем управления (при расхождении более чем на 20сек). Совместим как с WinXP, так и с Win7.

	"demo 7". Функциональных изменений нет. В учебных целях привожу код к более современному стилю C++. Насколько это возможно с 6-м Билдером...
	"demo 6". В клиенте добавил фон рабочего стола и доработал механизм восстановления после сбоев. Мелкие исправления.
	"demo 5". В модуле управления исправил генерацию паролей, перенес хранение его настроек и ключа аутентификации в реестр - подальше от рукастых админов. В клиенте максимум функций перенес в службу. TLKRte больше не существует. Исправил управление маршрутизацией под Win7. Добавил настроек.
	"demo 3". Исправил в просмотрщике логов обработку команды "Открыть [для настройки]", добавил фильтры (в контекстном меню на записях лога). В модуле управления добавил быстрый вызов основных операций.
	"demo 2" - не существенные доработки модуля управления и клиента, устранение ошибок. Баг с прозрачностью в режиме shell'а не победил...
	В "demo 1" заменил блокировку программ путем принудительного сворачивания окон на более адекватную... Добавил экспериментальный режим прозрачности shell'а, оптимизацию отрисовки некоторых окон и настройку таймера сообщения об окончании времени. В списке программ теперь не обязательно указывать файл с иконкой. Вернул принудительный режим для перезагрузки и выключения клиента. Исправил не значительные ошибки.
	TLK 3.11 - начал доработку клиента, т.к. он не отвечает даже минимальным современным требованиям.

	В "demo 8" продолжил приводить в порядок код программы, исправлять ошибки и не доработки. Удалил лишние опции и код, добавил описаний. Заменил хранение паролей в "plain text" на хэши. Добавил аутентификацию клиентов и модуля управления через HMAC-SHA, простую защиту от replay-атак. Работает как при синхронизации режима работы, так и при обмене настройками. 
	В "demo 7" в основном выполнил реструктуризацию, чтобы вынести общие части в "ядро" и убрать повторяющийся в разных модулях код. Добавил описаний и обновил до C++Builder 6. Переделал модуль маршрутизации, исправил синхронизацию по UDP (клиент рассылал броадкасты). Чуть улучшил шифрование, но оно осталось "самопальным" с ключем 32-бита.
	В "demo 6" были удалены не реализованные опции, засорявшие интерфейс. Переделан редактор тарифов, диалоги запуска/штрафования стали проще и понятнее. Аккаунт сис.админа заменен единственным паролем для входа в настройки модуля управления. Сам модуль теперь запускается и в отсутствие начатой смены. Добавлены его настройки.
	TLK 3.10 - переработка базового кода.


	По вопросам по функциональности и исходному коду, можно писать на denm.mmm@gmail.com, Денис Матвеев.


                               Системные требования
================================================================================
	Любой PentiumPro-совместимый ПК (i586) с 2-4Мбайт свободной RAM для TLK. Для просмотрщика логов может потребоваться больше памяти. Зависит количества записей в логе.
	ОС - Windows от WinXP до Win7 как минимум.


                                 Процесс установки
================================================================================
	Клиент:
1. Создаем папку вида "C:\Program Files\TLK Client".
2. Копируем в нее "TLk.exe" и картинки сообщений, "VPlay.exe" - по-желанию. Шрифт копируем в "C:\Windows\Fonts".
3. Заносим в реестр "default.reg". Запускаем "tlk.exe /install".
4. Открываем в фаерволле порт 7005 TCP/UDP или добавляем "tlk.exe" в список разрешенных процессов.
5. Создаем пользователя без прав администратора, настраиваем, заменяем shell своим или заглушкой: "HKCR\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" ключ "shell". Включаем атоматический вход в систему для него.
6. Задаем статический IP и DNS. Если нужно, чтобы TLK управлял доступом в Интернет, не указываем основной шлюз. Он будет добавляться динамически с адресом первого DNS-сервера.
7. Перезагружаемся и идем в модуль управления.

	Модуль управления:
1. Создаем папку вида "C:\Program Files\TLK Admin" и папку "logs" в ней.
2. Копируем в нее "AdminMdl.exe" и dat-файлы. Заносим в реестр "default.reg".
3. Создаем пользователя, от имени которого будет запускаться модуль управления. Разрешаем ему, как минимум, писать в папку "...\TLK Admin\logs" и изменять "...\TLK Admin\ARP.DAT", "...\TLK Admin\STATES.DAT". Запрещаем интерактивный вход в систему и создаем для админов ярлык на "AdminMdl.exe" с запомненным логином/паролем. Жаль что так, но делать службой модуль управления не готов.
4. Из под пользователя с полным доступом к папке модуля управления настраиваем его, раздаем клиентам список программ и логин пользователя из п.5 настройки клиента. Переагружаем компьютеры.
5. По-хорошему, стоит сгенерировать новый ключ аутентификации и занести в реестр на компьютерах (он же в п.3 настройки клиента). Не забываем запретить доступ к редактору реестра для админов и на компьютерах. Иначе залом можно будет "порулить" с копии программы.


                 Безопасноть и обращение с файлами настроек, логами
================================================================================
	Т.к. модуль управления выполнен в виде приложения, а не службы, я рекомендую устанавливать его как shell на рабочем месте администратора зала. В прежних версиях была простая защита от подмены лога (как минимум). С 3.10 отказался от всяких ухищрений, т.к. актуальнее использовать средства ОС для разграничения прав доступа.
	Модуль управления при каждом запуске считывает весь текущий лог для проверки его целостности, определения чья смена начата (да, это берется из лога...) и других служебных параметров. Если лог окажется поврежден, TLK попытается его переименовать и начать новый файл. Для обеспечения надежной интерпретации просмотрщиком при старте записываются: текущее состояние зала, тарифы, штрафы, пользователи. Далее при выполнении каждой команды в логе сохраняются лишь ID нужного параметра настроек. Поэтому, если оказался поврежден файл USERS.DAT/TARIFFS.DAT/FINES.DAT, рекомендую перед восстановлением из копии начать новый лог. Внутренние ID зависят от системных часов и их уникальность достаточна, но это все же не SQL GUID...
	В случае отсутствия доступа к файлу лога или нехватки места на диске, TLK откажется выполнять команды. Если будет поврежден или не удачно сохранен какой-либо файл настроек, произойдет блокировка модуля управления. Открыть его можно будет только под паролем настроек для устранения проблемы.
	Два постоянно изменяющихся файла CURRENT.TLG и STATES.DAT сохраняются на диск без кэширования записи. Необходимое место в них выделяется перед [пере]записью данных, что гарантирует целостность. Файлы открываются только по-необходимости, поэтому даже жесткий reset не должен вызывать проблем.


            Замена не нужных программ в системе программой-заглушкой
================================================================================
	С TLK поставляется маленькая программка "ExeRepl.exe". При запуске она просто ничего не делает. Пользы от нее сейчас ~"0"...


                              Просмотр фильмов
================================================================================
	С TLK поставляется простой видео-плейер. Он позволяет воспроизводить медиа-данные для установленных в системе кодеков (DivX, например). Для просмотра фильма нужно занести в список игр примерно следующее:
"C:\Program Files\TLK Client\VPlay.exe" D:\Video\Блейд 2.avi
	Чтобы не нагружать закрытый компьютер бесполезной работой, плейер автоматически останавливает воспроизведение, если его окно некоторое время не активно.


                  Задание времени при запуске компьютеров
================================================================================
	Время, на которое запускается компьютер, в зависимости от тарифной сетки выбирается из списка или задается с точностью до минуты в виде "часы:минуты". Не забывайте для полутора часов писать последний ноль, т.е. "1:30", а не "1:3".
